<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢°æ’çƒå°æ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            position: relative;
        }
        
        /* æ·»åŠ æ˜Ÿç©ºèƒŒæ™¯æ•ˆæœ */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 1px, transparent 1px),
                radial-gradient(white, rgba(255,255,255,.15) 2px, transparent 1px);
            background-size: 50px 50px, 70px 70px;
            opacity: 0.2;
            z-index: -1;
        }
        
        .game-container {
            position: relative;
            border: 3px solid #5d5dff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7),
                        inset 0 0 20px rgba(93, 93, 255, 0.3);
            background: rgba(15, 30, 39, 0.85);
            backdrop-filter: blur(5px);
            overflow: hidden;
        }
        canvas {
            display: block;
            border-radius: 12px;
            background: rgba(10, 20, 30, 0.7);
            box-shadow: inset 0 0 15px rgba(93, 93, 255, 0.5);
        }
        .title {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7),
                         0 0 20px rgba(93, 93, 255, 0.8);
            letter-spacing: 1px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(93, 93, 255, 0.5); }
            50% { text-shadow: 0 0 15px rgba(255, 255, 255, 1), 0 0 30px rgba(93, 93, 255, 0.9); }
            100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(93, 93, 255, 0.5); }
        }
        .controls {
            margin: 25px 0 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
        }
        button {
            background: linear-gradient(to bottom, #5d5dff, #3d3dbd);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            background: linear-gradient(to bottom, #3d3dbd, #2d2d8d);
        }
        button:active {
            transform: translateY(1px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #95a5a6;
        }
        button i {
            font-size: 18px;
        }
        .info {
            color: rgba(255, 255, 255, 0.85);
            font-size: 16px;
            margin: 15px 0 10px;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        .stats {
            display: flex;
            justify-content: space-around;
            width: 600px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 8px;
            font-size: 14px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            min-width: 120px;
            margin: 5px 0;
        }
        .score-display {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            margin: 10px 0;
            text-align: center;
        }
        .high-score {
            font-size: 16px;
            color: #FFA500;
            margin-top: 5px;
        }
        @media (max-width: 650px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            .stats {
                flex-direction: column;
                gap: 5px;
                width: 90%;
            }
            .score-display {
                font-size: 24px;
            }
            canvas {
                width: 95vw;
                height: 60vw;
            }
            .game-container {
                width: 95vw;
            }
        }
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 12px;
            display: none;
        }
        .pause-text {
            font-size: 48px;
            color: white;
            text-shadow: 0 0 20px #5d5dff;
            animation: pulse 1.5s infinite;
        }
        .score-popup {
            position: absolute;
            color: #FFD700;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.9);
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.5s;
            animation: floatUp 1s forwards;
        }
        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-30px);
                opacity: 0;
            }
        }
        .game-instructions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            max-width: 600px;
        }
        .instructions-title {
            font-weight: bold;
            color: #5d5dff;
            margin-bottom: 5px;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            gap: 10px;
            flex-wrap: wrap;
        }
        .mode-btn {
            background: rgba(93, 93, 255, 0.7);
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .mode-btn.active {
            background: rgba(46, 204, 113, 0.9);
            border-color: white;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.7);
        }
        .mode-btn:hover:not(.active) {
            background: rgba(93, 93, 255, 0.9);
        }
        .slider-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            min-width: 180px;
        }
        .slider-container label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #5d5dff;
        }
        .slider {
            width: 100%;
            margin: 5px 0;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(93, 93, 255, 0.3);
            border-radius: 4px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5d5dff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(93, 93, 255, 0.8);
        }
        .slider-value {
            text-align: center;
            font-size: 14px;
            color: #fff;
            font-weight: bold;
        }
        .trail-effect {
            position: absolute;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.7;
        }
        .speed-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #5d5dff;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            z-index: 5;
        }
        
        /* æ·»åŠ çƒé€‰é¡¹æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            background: rgba(30, 40, 70, 0.95);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(93, 93, 255, 0.5);
            border: 2px solid #5d5dff;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal.active .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #5d5dff;
            text-shadow: 0 0 10px rgba(93, 93, 255, 0.7);
        }
        .ball-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .option-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        .color-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }
        .cancel-btn {
            background: #e74c3c;
            color: white;
        }
        .confirm-btn {
            background: #2ecc71;
            color: white;
        }
        .cancel-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .confirm-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        .preset-colors {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .preset-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .preset-color:hover {
            transform: scale(1.2);
        }
        .custom-color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        #customColorInput {
            width: 60px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="game-container">
            <div class="title">å¢å¼ºç‰©ç†ç¢°æ’çƒæ¨¡æ‹Ÿå™¨</div>
            <canvas id="gameCanvas" width="600" height="400"></canvas>
            <div class="pause-overlay" id="pauseOverlay">
                <div class="pause-text">âšâš</div>
            </div>
            <div class="speed-indicator" id="speedIndicator">é€Ÿåº¦: 1.0x</div>
        </div>
        
        <div class="score-display">
            åˆ†æ•°: <span id="score">0</span>
            <div class="high-score">å†å²æœ€é«˜: <span id="highScore">0</span></div>
        </div>
        
        <div class="stats">
            <div class="stat-item">çƒæ•°é‡: <span id="ballCount">3</span>/15</div>
            <div class="stat-item">ç¢°æ’æ¬¡æ•°: <span id="collisionCount">0</span></div>
            <div class="stat-item">FPS: <span id="fps">0</span></div>
            <div class="stat-item">è¿å‡»: <span id="combo">0</span>x</div>
            <div class="stat-item">ç‰©ç†æ¨¡å¼: <span id="physicsMode">æ ‡å‡†</span></div>
        </div>
        
        <div class="mode-selector">
            <div class="mode-btn active" data-mode="standard">æ ‡å‡†æ¨¡å¼</div>
            <div class="mode-btn" data-mode="friction">æ‘©æ“¦åŠ›æ¨¡å¼</div>
            <div class="mode-btn" data-mode="gravity">é‡åŠ›æ¨¡å¼</div>
            <div class="mode-btn" data-mode="zero-g">é›¶é‡åŠ›</div>
        </div>
        
        <div class="controls">
            <button id="changeColorBtn">
                <i class="fas fa-palette"></i> éšæœºé¢œè‰²
            </button>
            <button id="addBallBtn">
                <i class="fas fa-plus-circle"></i> æ·»åŠ çƒ
            </button>
            <button id="clearBtn">
                <i class="fas fa-broom"></i> æ¸…é™¤æ‰€æœ‰
            </button>
            <button id="pauseBtn">
                <i class="fas fa-pause"></i> æš‚åœ
            </button>
            <button id="resetSpeedBtn">
                <i class="fas fa-sync-alt"></i> é‡ç½®é€Ÿåº¦
            </button>
        </div>
        
        <div class="slider-controls">
            <div class="slider-container">
                <label for="frictionRange">æ‘©æ“¦åŠ›ç³»æ•°</label>
                <input type="range" id="frictionRange" class="slider" min="0" max="100" value="5">
                <div class="slider-value">æ‘©æ“¦: <span id="frictionValue">0.05</span></div>
            </div>
            <div class="slider-container">
                <label for="gravityRange">é‡åŠ›å¼ºåº¦</label>
                <input type="range" id="gravityRange" class="slider" min="0" max="20" value="10">
                <div class="slider-value">é‡åŠ›: <span id="gravityValue">0.5</span></div>
            </div>
            <div class="slider-container">
                <label for="speedMultiplierRange">æ¸¸æˆé€Ÿåº¦å€ç‡</label>
                <input type="range" id="speedMultiplierRange" class="slider" min="1" max="100" value="50">
                <div class="slider-value">é€Ÿåº¦: <span id="speedMultiplierValue">1.0</span>x</div>
            </div>
        </div>
        
        <div class="info">
            âš›ï¸ ç‰©ç†ç‰¹æ€§ï¼šçƒä½“ä¹‹é—´ä¼šçœŸå®ç¢°æ’ï¼Œé€Ÿåº¦å’Œè§’åº¦éµå¾ªåŠ¨é‡å®ˆæ’å®šå¾‹<br>
            ğŸšï¸ æç¤ºï¼šç‚¹å‡»çƒä½“å¯å•ç‹¬æ”¹å˜å…¶é¢œè‰²ï¼Œæ‹–æ‹½å¯è‡ªå®šä¹‰åˆé€Ÿåº¦
        </div>
        
        <div class="game-instructions">
            <div class="instructions-title">è®¡åˆ†è§„åˆ™:</div>
            <div>â€¢ çƒä¸çƒç¢°æ’: +10 åˆ†</div>
            <div>â€¢ çƒä¸è¾¹ç•Œç¢°æ’: +1 åˆ†</div>
            <div>â€¢ è¿ç»­ç¢°æ’(1ç§’å†…): å¥–åŠ±é¢å¤–åˆ†æ•°</div>
            <div>â€¢ åŒæ—¶å­˜åœ¨5ä¸ªä»¥ä¸Šçƒ: åŒå€å¾—åˆ†</div>
            <div>â€¢ é‡åŠ›/æ‘©æ“¦åŠ›æ¨¡å¼: é¢å¤–å¾—åˆ†åŠ æˆ</div>
        </div>
    </div>

    <!-- æ·»åŠ çƒé€‰é¡¹æ¨¡æ€æ¡† -->
    <div class="modal" id="addBallModal">
        <div class="modal-content">
            <div class="modal-title">è‡ªå®šä¹‰æ–°çƒå‚æ•°</div>
            <div class="ball-options">
                <div class="option-group">
                    <label for="ballSpeedRange">åˆå§‹é€Ÿåº¦èŒƒå›´</label>
                    <input type="range" id="ballSpeedRange" class="slider" min="1" max="15" value="6">
                    <div class="slider-value">é€Ÿåº¦: <span id="ballSpeedValue">6</span></div>
                </div>
                <div class="option-group">
                    <label for="ballSizeRange">çƒä½“å¤§å°</label>
                    <input type="range" id="ballSizeRange" class="slider" min="10" max="50" value="25">
                    <div class="slider-value">å¤§å°: <span id="ballSizeValue">25</span></div>
                </div>
                <div class="option-group">
                    <label>çƒä½“é¢œè‰²</label>
                    <div class="preset-colors">
                        <div class="preset-color" style="background-color: #FF6B6B;" data-color="#FF6B6B"></div>
                        <div class="preset-color" style="background-color: #4ECDC4;" data-color="#4ECDC4"></div>
                        <div class="preset-color" style="background-color: #45B7D1;" data-color="#45B7D1"></div>
                        <div class="preset-color" style="background-color: #96CEB4;" data-color="#96CEB4"></div>
                        <div class="preset-color" style="background-color: #FECA57;" data-color="#FECA57"></div>
                        <div class="preset-color" style="background-color: #F368E0;" data-color="#F368E0"></div>
                        <div class="preset-color" style="background-color: #54A0FF;" data-color="#54A0FF"></div>
                        <div class="preset-color" style="background-color: #00D2D3;" data-color="#00D2D3"></div>
                        <div class="preset-color" style="background-color: #A55EE7;" data-color="#A55EE7"></div>
                        <div class="preset-color" style="background-color: #FF9F43;" data-color="#FF9F43"></div>
                        <div class="preset-color" style="background-color: #1DD1A1;" data-color="#1DD1A1"></div>
                        <div class="preset-color" style="background-color: #5F27CD;" data-color="#5F27CD"></div>
                    </div>
                    <div class="custom-color-picker">
                        <span>è‡ªå®šä¹‰é¢œè‰²:</span>
                        <input type="color" id="customColorInput" value="#54A0FF">
                        <button id="applyCustomColor" class="modal-btn confirm-btn">åº”ç”¨</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" id="cancelAddBall">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirmAddBall">æ·»åŠ çƒ</button>
            </div>
        </div>
    </div>

    <script>
        // è·å–canvaså…ƒç´ å’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const speedIndicator = document.getElementById('speedIndicator');
        const addBallModal = document.getElementById('addBallModal');
        
        // æ¸¸æˆå‚æ•°
        const balls = [];
        let collisionCounter = 0;
        let lastTimestamp = 0;
        let frameCount = 0;
        let fps = 0;
        let animationId;
        let isPaused = false;
        let mouseX = 0;
        let mouseY = 0;
        let score = 0;
        let highScore = localStorage.getItem('collisionBallHighScore') || 0;
        let comboCounter = 0;
        let lastCollisionTime = 0;
        let scorePopups = [];
        let isDragging = false;
        let draggedBall = null;
        let dragStartX = 0;
        let dragStartY = 0;
        
        // ç‰©ç†å‚æ•°
        let physicsMode = 'standard'; // standard, friction, gravity, zero-g
        let frictionCoefficient = 0.05; // æ‘©æ“¦ç³»æ•°
        let gravityStrength = 0.5; // é‡åŠ›å¼ºåº¦
        let speedMultiplier = 1.0; // é€Ÿåº¦å€ç‡ï¼Œé»˜è®¤1.0å€
        
        // é¢œè‰²æ–¹æ¡ˆ
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
            '#FECA57', '#F368E0', '#54A0FF', '#00D2D3',
            '#A55EE7', '#FF9F43', '#1DD1A1', '#5F27CD'
        ];
        
        // å½“å‰é€‰æ‹©çš„é¢œè‰²
        let selectedColor = colors[6]; // é»˜è®¤é€‰ä¸­ç¬¬7ä¸ªé¢œè‰²
        
        // åˆ›å»ºçƒçš„æ„é€ å‡½æ•°
        class Ball {
            constructor(x, y, radius, color, speedX = null, speedY = null, speedRange = 6) {
                this.x = x || Math.random() * (canvas.width - 80) + 40;
                this.y = y || Math.random() * (canvas.height - 80) + 40;
                this.radius = radius || 25;
                this.color = color || colors[Math.floor(Math.random() * colors.length)];
                this.mass = Math.PI * this.radius * this.radius; // è´¨é‡ä¸é¢ç§¯æˆæ­£æ¯”
                
                // éšæœºé€Ÿåº¦æˆ–è‡ªå®šä¹‰é€Ÿåº¦
                if (speedX !== null && speedY !== null) {
                    this.dx = speedX;
                    this.dy = speedY;
                } else {
                    const baseSpeed = speedRange;
                    this.dx = (Math.random() - 0.5) * baseSpeed * 2;
                    this.dy = (Math.random() - 0.5) * baseSpeed * 2;
                }
                
                this.lastCollision = 0; // ç”¨äºé˜²æ­¢è¿ç»­ç¢°æ’
                this.lastWallCollision = 0; // ç”¨äºé˜²æ­¢è¿ç»­å¢™ç¢°æ’
                this.trail = []; // ç”¨äºè½¨è¿¹æ•ˆæœ
                this.elasticity = 0.95; // å¼¹æ€§ç³»æ•°
                this.isStatic = false; // æ˜¯å¦ä¸ºé™æ€çƒ
            }
            
            // æ›´æ–°çƒçš„ä½ç½®
            update(deltaTime) {
                // è®°å½•è½¨è¿¹
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > 10) {
                    this.trail.shift();
                }
                
                // å°†deltaTimeä¹˜ä»¥é€Ÿåº¦å€ç‡
                const adjustedDeltaTime = deltaTime * speedMultiplier;
                
                // åº”ç”¨ç‰©ç†æ•ˆæœ
                if (physicsMode === 'friction') {
                    // æ‘©æ“¦åŠ›æ¨¡å¼ï¼šé€Ÿåº¦é€æ¸å‡å°
                    const friction = 1 - frictionCoefficient * adjustedDeltaTime / 16;
                    this.dx *= friction;
                    this.dy *= friction;
                } else if (physicsMode === 'gravity') {
                    // é‡åŠ›æ¨¡å¼ï¼šå‘ä¸‹åŠ é€Ÿ
                    this.dy += gravityStrength * adjustedDeltaTime / 16;
                } else if (physicsMode === 'zero-g') {
                    // é›¶é‡åŠ›ï¼šæ²¡æœ‰é‡åŠ›ï¼Œä½†æœ‰è½»å¾®é˜»åŠ›
                    this.dx *= 0.999;
                    this.dy *= 0.999;
                }
                
                // æ›´æ–°ä½ç½® (ä½¿ç”¨è°ƒæ•´åçš„æ—¶é—´)
                this.x += this.dx * adjustedDeltaTime / 16;
                this.y += this.dy * adjustedDeltaTime / 16;
                
                // æ£€æµ‹ä¸è¾¹ç•Œçš„ç¢°æ’
                this.handleBoundaryCollision(adjustedDeltaTime);
                
                // é€Ÿåº¦é™åˆ¶ - é˜²æ­¢é€Ÿåº¦è¿‡å¤§
                const maxSpeed = 20 * speedMultiplier;
                const speed = Math.sqrt(this.dx * this.dx + this.dy * this.dy);
                if (speed > maxSpeed) {
                    this.dx = (this.dx / speed) * maxSpeed;
                    this.dy = (this.dy / speed) * maxSpeed;
                }
            }
            
            // å¤„ç†è¾¹ç•Œç¢°æ’
            handleBoundaryCollision(deltaTime) {
                const now = Date.now();
                let wallCollision = false;
                const comboThreshold = 1000; // 1ç§’å†…å¤šæ¬¡ç¢°æ’ç®—è¿å‡»
                
                // å³è¾¹ç•Œ
                if (this.x + this.radius > canvas.width) {
                    this.x = canvas.width - this.radius;
                    this.dx = -this.dx * this.elasticity;
                    wallCollision = true;
                }
                // å·¦è¾¹ç•Œ
                if (this.x - this.radius < 0) {
                    this.x = this.radius;
                    this.dx = -this.dx * this.elasticity;
                    wallCollision = true;
                }
                // ä¸‹è¾¹ç•Œ
                if (this.y + this.radius > canvas.height) {
                    this.y = canvas.height - this.radius;
                    
                    if (physicsMode === 'gravity') {
                        // é‡åŠ›æ¨¡å¼ä¸‹ï¼Œä¸‹è¾¹ç•Œæœ‰å¼¹æ€§
                        this.dy = -this.dy * this.elasticity;
                        
                        // å¦‚æœé€Ÿåº¦å¤ªå°ï¼Œåœæ­¢è¿åŠ¨
                        if (Math.abs(this.dy) < 0.5 && Math.abs(this.dx) < 0.5) {
                            this.dy = 0;
                            this.dx *= 0.9; // æ°´å¹³æ–¹å‘ç»§ç»­å‡é€Ÿ
                        }
                    } else {
                        this.dy = -this.dy * this.elasticity;
                    }
                    
                    wallCollision = true;
                }
                // ä¸Šè¾¹ç•Œ
                if (this.y - this.radius < 0) {
                    this.y = this.radius;
                    this.dy = -this.dy * this.elasticity;
                    wallCollision = true;
                }
                
                // è®¡åˆ†ï¼šè¾¹ç•Œç¢°æ’
                if (wallCollision && now - this.lastWallCollision > 100) {
                    let points = 1;
                    
                    // é‡åŠ›/æ‘©æ“¦åŠ›æ¨¡å¼ä¸‹é¢å¤–åŠ åˆ†
                    if (physicsMode === 'friction' || physicsMode === 'gravity') {
                        points += 2;
                    }
                    
                    addScore(points, this.x, this.y - this.radius);
                    this.lastWallCollision = now;
                    
                    // æ›´æ–°è¿å‡»
                    if (now - lastCollisionTime < comboThreshold) {
                        comboCounter++;
                    } else {
                        comboCounter = 1;
                    }
                    lastCollisionTime = now;
                    updateComboDisplay();
                }
            }
            
            // ç»˜åˆ¶çƒ
            draw() {
                // ç»˜åˆ¶è½¨è¿¹
                if (physicsMode !== 'standard') {
                    for (let i = 0; i < this.trail.length; i++) {
                        const alpha = i / this.trail.length * 0.3;
                        ctx.beginPath();
                        ctx.arc(this.trail[i].x, this.trail[i].y, this.radius * (i / this.trail.length), 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(${parseInt(this.color.slice(1,3), 16)}, ${parseInt(this.color.slice(3,5), 16)}, ${parseInt(this.color.slice(5,7), 16)}, ${alpha})`;
                        ctx.fill();
                    }
                }
                
                // ç»˜åˆ¶çƒä½“
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                // æ·»åŠ å‘å…‰æ•ˆæœ
                const gradient = ctx.createRadialGradient(
                    this.x - this.radius/3, this.y - this.radius/3, 0,
                    this.x, this.y, this.radius
                );
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // æè¾¹
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.closePath();
                
                // æ·»åŠ é«˜å…‰
                ctx.beginPath();
                ctx.arc(this.x - this.radius/3, this.y - this.radius/3, this.radius/3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.fill();
                
                // ç»˜åˆ¶é€Ÿåº¦æŒ‡ç¤ºå™¨
                if (Math.sqrt(this.dx*this.dx + this.dy*this.dy) > 0.5) {
                    const speed = Math.min(Math.sqrt(this.dx*this.dx + this.dy*this.dy), 10);
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(
                        this.x + this.dx * 2,
                        this.y + this.dy * 2
                    );
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.lineWidth = 2 + speed/5;
                    ctx.stroke();
                }
            }
            
            // æ£€æµ‹æ˜¯å¦è¢«ç‚¹å‡»
            isClicked(x, y) {
                const dx = this.x - x;
                const dy = this.y - y;
                return Math.sqrt(dx * dx + dy * dy) < this.radius;
            }
            
            // è®¾ç½®é™æ€çƒï¼ˆå›ºå®šä½ç½®ï¼‰
            setStatic() {
                this.isStatic = true;
                this.dx = 0;
                this.dy = 0;
                this.elasticity = 0.7; // é™æ€çƒå¼¹æ€§è¾ƒå°
                this.color = '#8E44AD';
            }
            
            // é‡ç½®é€Ÿåº¦
            resetSpeed() {
                if (this.isStatic) return;
                
                const baseSpeed = 6; // é»˜è®¤é€Ÿåº¦
                this.dx = (Math.random() - 0.5) * baseSpeed * 2;
                this.dy = (Math.random() - 0.5) * baseSpeed * 2;
                this.trail = [];
            }
        }
        
        // æ£€æµ‹çƒä¹‹é—´çš„ç¢°æ’
        function detectCollision(ball1, ball2) {
            const dx = ball1.x - ball2.x;
            const dy = ball1.y - ball2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < ball1.radius + ball2.radius && 
                Date.now() - ball1.lastCollision > 100 &&
                Date.now() - ball2.lastCollision > 100) {
                
                // å¦‚æœå…¶ä¸­ä¸€ä¸ªæ˜¯é™æ€çƒï¼Œåªæ”¹å˜åŠ¨çƒçš„é€Ÿåº¦
                if (ball1.isStatic || ball2.isStatic) {
                    handleStaticCollision(ball1, ball2);
                    return true;
                }
                
                // è®¡ç®—ç¢°æ’åçš„é€Ÿåº¦ï¼ˆåŸºäºåŠ¨é‡å®ˆæ’ï¼‰
                const angle = Math.atan2(dy, dx);
                const sin = Math.sin(angle);
                const cos = Math.cos(angle);
                
                // è®¡ç®—æ—‹è½¬åçš„ä½ç½®
                const pos1 = {x: 0, y: 0};
                const pos2 = {x: distance * cos, y: distance * sin};
                
                // è®¡ç®—æ—‹è½¬åçš„é€Ÿåº¦
                const vel1 = rotate(ball1.dx, ball1.dy, sin, cos, true);
                const vel2 = rotate(ball2.dx, ball2.dy, sin, cos, true);
                
                // ç¢°æ’åé€Ÿåº¦äº¤æ¢ï¼ˆè€ƒè™‘è´¨é‡å’Œå¼¹æ€§ï¼‰
                const velocity1 = ((ball1.mass - ball2.mass) * vel1.x + 2 * ball2.mass * vel2.x) / (ball1.mass + ball2.mass);
                const velocity2 = ((ball2.mass - ball1.mass) * vel2.x + 2 * ball1.mass * vel1.x) / (ball1.mass + ball2.mass);
                
                // åº”ç”¨å¼¹æ€§ç³»æ•°
                const elasticity = (ball1.elasticity + ball2.elasticity) / 2;
                
                // æ›´æ–°é€Ÿåº¦
                const newVel1 = rotate(velocity1 * elasticity, vel1.y * elasticity, sin, cos, false);
                const newVel2 = rotate(velocity2 * elasticity, vel2.y * elasticity, sin, cos, false);
                
                // åº”ç”¨æ–°é€Ÿåº¦
                ball1.dx = newVel1.x;
                ball1.dy = newVel1.y;
                ball2.dx = newVel2.x;
                ball2.dy = newVel2.y;
                
                // é˜²æ­¢çƒä½“ç²˜è¿
                const overlap = ball1.radius + ball2.radius - distance;
                if (overlap > 0) {
                    const moveX = (overlap / 2) * (dx / distance);
                    const moveY = (overlap / 2) * (dy / distance);
                    
                    ball1.x += moveX;
                    ball1.y += moveY;
                    ball2.x -= moveX;
                    ball2.y -= moveY;
                }
                
                // è®°å½•ç¢°æ’æ—¶é—´
                ball1.lastCollision = Date.now();
                ball2.lastCollision = Date.now();
                
                // æ›´æ–°ç¢°æ’è®¡æ•°
                collisionCounter++;
                document.getElementById('collisionCount').textContent = collisionCounter;
                
                // è®¡åˆ†ï¼šçƒä¸çƒç¢°æ’
                const now = Date.now();
                let baseScore = 10;
                
                // é‡åŠ›/æ‘©æ“¦åŠ›æ¨¡å¼ä¸‹é¢å¤–åŠ åˆ†
                if (physicsMode === 'friction' || physicsMode === 'gravity') {
                    baseScore += 5;
                }
                
                let bonusScore = 0;
                
                // è¿å‡»åŠ åˆ†
                if (now - lastCollisionTime < 1000) {
                    comboCounter++;
                    bonusScore = Math.min(comboCounter * 2, 20); // æœ€å¤šé¢å¤–20åˆ†
                } else {
                    comboCounter = 1;
                }
                
                // å¤šçƒå¥–åŠ± - 5ä¸ªçƒä»¥ä¸ŠåŒå€å¾—åˆ†
                let finalScore = baseScore + bonusScore;
                if (balls.length >= 5) {
                    finalScore *= 2;
                }
                
                addScore(finalScore, (ball1.x + ball2.x) / 2, (ball1.y + ball2.y) / 2 - 20);
                lastCollisionTime = now;
                updateComboDisplay();
                
                // åˆ›å»ºç¢°æ’æ•ˆæœ
                createCollisionEffect((ball1.x + ball2.x) / 2, (ball1.y + ball2.y) / 2, ball1.color, ball2.color);
                
                return true;
            }
            return false;
        }
        
        // é™æ€çƒç¢°æ’å¤„ç†
        function handleStaticCollision(ball1, ball2) {
            let movingBall = ball1.isStatic ? ball2 : ball1;
            let staticBall = ball1.isStatic ? ball1 : ball2;
            
            // è®¡ç®—ç¢°æ’æ–¹å‘
            const dx = movingBall.x - staticBall.x;
            const dy = movingBall.y - staticBall.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // è®¡ç®—æ³•å‘é‡
            const nx = dx / distance;
            const ny = dy / distance;
            
            // è®¡ç®—ç›¸å¯¹é€Ÿåº¦
            const vx = movingBall.dx;
            const vy = movingBall.dy;
            
            // è®¡ç®—æ³•å‘é€Ÿåº¦
            const vn = vx * nx + vy * ny;
            
            // åº”ç”¨å¼¹æ€§ç³»æ•°
            const elasticity = staticBall.elasticity;
            
            // æ›´æ–°é€Ÿåº¦
            movingBall.dx = vx - (1 + elasticity) * vn * nx;
            movingBall.dy = vy - (1 + elasticity) * vn * ny;
            
            // é˜²æ­¢ç²˜è¿
            const overlap = staticBall.radius + movingBall.radius - distance;
            if (overlap > 0) {
                movingBall.x += (overlap + 0.1) * nx;
                movingBall.y += (overlap + 0.1) * ny;
            }
            
            // è®°å½•ç¢°æ’
            movingBall.lastCollision = Date.now();
            staticBall.lastCollision = Date.now();
            
            // è®¡åˆ†
            const now = Date.now();
            let baseScore = 8; // é™æ€çƒç¢°æ’åˆ†æ•°ç•¥ä½
            
            addScore(baseScore, movingBall.x, movingBall.y);
        }
        
        // æ—‹è½¬é€Ÿåº¦å‘é‡
        function rotate(x, y, sin, cos, reverse) {
            const result = {x: 0, y: 0};
            if (reverse) {
                result.x = x * cos + y * sin;
                result.y = y * cos - x * sin;
            } else {
                result.x = x * cos - y * sin;
                result.y = y * cos + x * sin;
            }
            return result;
        }
        
        // åˆ›å»ºç¢°æ’ç‰¹æ•ˆ
        function createCollisionEffect(x, y, color1, color2) {
            const gameContainer = document.querySelector('.game-container');
            const effectSize = 30;
            
            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            const effect = document.createElement('div');
            effect.className = 'trail-effect';
            effect.style.left = (x - effectSize/2) + 'px';
            effect.style.top = (y - effectSize/2) + 'px';
            effect.style.width = effectSize + 'px';
            effect.style.height = effectSize + 'px';
            effect.style.background = `radial-gradient(circle, ${color1} 0%, ${color2} 50%, transparent 70%)`;
            
            gameContainer.appendChild(effect);
            
            // åŠ¨ç”»æ•ˆæœ
            let opacity = 0.7;
            let size = effectSize;
            
            const animateEffect = () => {
                size += 3;
                opacity -= 0.05;
                
                effect.style.width = size + 'px';
                effect.style.height = size + 'px';
                effect.style.left = (x - size/2) + 'px';
                effect.style.top = (y - size/2) + 'px';
                effect.style.opacity = opacity;
                
                if (opacity <= 0) {
                    effect.remove();
                    return;
                }
                
                requestAnimationFrame(animateEffect);
            };
            
            requestAnimationFrame(animateEffect);
        }
        
        // æ·»åŠ åˆ†æ•°
        function addScore(points, x, y) {
            score += points;
            document.getElementById('score').textContent = score;
            
            // åˆ›å»ºåˆ†æ•°æµ®åŠ¨æ•ˆæœ
            createScorePopup(points, x, y);
            
            // æ£€æŸ¥æ˜¯å¦ç ´çºªå½•
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('collisionBallHighScore', highScore);
                document.getElementById('highScore').textContent = highScore;
                
                // ç ´çºªå½•ç‰¹æ•ˆ
                showRecordAnimation();
            }
        }
        
        // åˆ›å»ºåˆ†æ•°æµ®åŠ¨æ•ˆæœ
        function createScorePopup(points, x, y) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = '+' + points;
            popup.style.left = (x - 30) + 'px';
            popup.style.top = (y - 10) + 'px';
            
            const gameContainer = document.querySelector('.game-container');
            gameContainer.appendChild(popup);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }
        
        // æ˜¾ç¤ºç ´çºªå½•åŠ¨ç”»
        function showRecordAnimation() {
            const gameContainer = document.querySelector('.game-container');
            const recordElement = document.createElement('div');
            recordElement.style.position = 'absolute';
            recordElement.style.top = '50%';
            recordElement.style.left = '50%';
            recordElement.style.transform = 'translate(-50%, -50%)';
            recordElement.style.fontSize = '48px';
            recordElement.style.color = '#FFD700';
            recordElement.style.fontWeight = 'bold';
            recordElement.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.9)';
            recordElement.style.zIndex = '20';
            recordElement.style.animation = 'pulse 0.5s 3';
            recordElement.textContent = 'æ–°çºªå½•!';
            
            gameContainer.appendChild(recordElement);
            
            setTimeout(() => {
                recordElement.remove();
            }, 1500);
        }
        
        // æ›´æ–°è¿å‡»æ˜¾ç¤º
        function updateComboDisplay() {
            document.getElementById('combo').textContent = comboCounter;
            
            // è¿å‡»ç‰¹æ•ˆ
            if (comboCounter >= 5) {
                document.getElementById('combo').style.color = '#FF5733';
                document.getElementById('combo').style.textShadow = '0 0 10px rgba(255, 87, 51, 0.8)';
            } else {
                document.getElementById('combo').style.color = '';
                document.getElementById('combo').style.textShadow = '';
            }
        }
        
        // æ›´æ–°é€Ÿåº¦æŒ‡ç¤ºå™¨
        function updateSpeedIndicator() {
            speedIndicator.textContent = `é€Ÿåº¦: ${speedMultiplier.toFixed(1)}x`;
            document.getElementById('speedMultiplierValue').textContent = speedMultiplier.toFixed(1);
        }
        
        // åˆ‡æ¢ç‰©ç†æ¨¡å¼
        function changePhysicsMode(mode) {
            physicsMode = mode;
            document.getElementById('physicsMode').textContent = 
                mode === 'standard' ? 'æ ‡å‡†' : 
                mode === 'friction' ? 'æ‘©æ“¦åŠ›' : 
                mode === 'gravity' ? 'é‡åŠ›' : 'é›¶é‡åŠ›';
                
            // æ›´æ–°æ¿€æ´»æŒ‰é’®
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
            
            // é‡ç½®çƒçš„é€Ÿåº¦
            if (mode !== 'standard') {
                balls.forEach(ball => {
                    if (!ball.isStatic) {
                        ball.resetSpeed();
                    }
                });
            }
        }
        
        // é‡ç½®æ‰€æœ‰çƒçš„é€Ÿåº¦
        function resetAllSpeeds() {
            balls.forEach(ball => {
                ball.resetSpeed();
            });
        }
        
        // åˆ›å»ºé™æ€çƒ
        function createStaticBall(x, y) {
            const staticBall = new Ball(x, y, 25 + Math.random() * 15);
            staticBall.setStatic();
            balls.push(staticBall);
            document.getElementById('ballCount').textContent = balls.length;
            updateButtonStates();
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            const addBtn = document.getElementById('addBallBtn');
            addBtn.disabled = balls.length >= 15;
        }
        
        // åˆ‡æ¢æš‚åœçŠ¶æ€
        function togglePause() {
            isPaused = !isPaused;
            pauseOverlay.style.display = isPaused ? 'flex' : 'none';
            
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.innerHTML = isPaused ? 
                '<i class="fas fa-play"></i> ç»§ç»­' : 
                '<i class="fas fa-pause"></i> æš‚åœ';
            
            if (!isPaused) {
                lastTimestamp = 0; // é‡ç½®æ—¶é—´æˆ³
                animate(0); // æ¢å¤åŠ¨ç”»
            } else {
                cancelAnimationFrame(animationId);
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ çƒé€‰é¡¹æ¨¡æ€æ¡†
        function showAddBallModal() {
            if (balls.length >= 15) return;
            
            // é‡ç½®æ¨¡æ€æ¡†ä¸­çš„å€¼
            document.getElementById('ballSpeedRange').value = 6;
            document.getElementById('ballSpeedValue').textContent = 6;
            document.getElementById('ballSizeRange').value = 25;
            document.getElementById('ballSizeValue').textContent = 25;
            
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.preset-color').forEach(el => {
                el.classList.remove('selected');
            });
            
            // é€‰ä¸­é»˜è®¤é¢œè‰²
            selectedColor = colors[6];
            const defaultColorEl = document.querySelector(`.preset-color[data-color="${selectedColor}"]`);
            if (defaultColorEl) {
                defaultColorEl.classList.add('selected');
            }
            
            document.getElementById('customColorInput').value = selectedColor;
            
            addBallModal.classList.add('active');
        }
        
        // éšè—æ·»åŠ çƒé€‰é¡¹æ¨¡æ€æ¡†
        function hideAddBallModal() {
            addBallModal.classList.remove('active');
        }
        
        // æ·»åŠ æ–°çƒ
        function addNewBall() {
            const speedRange = parseFloat(document.getElementById('ballSpeedRange').value);
            const radius = parseFloat(document.getElementById('ballSizeRange').value);
            
            // åœ¨é¼ æ ‡ä½ç½®æˆ–éšæœºä½ç½®åˆ›å»ºçƒ
            let x, y;
            if (mouseX > 0 && mouseY > 0 && mouseX < canvas.width && mouseY < canvas.height) {
                x = mouseX;
                y = mouseY;
            } else {
                x = Math.random() * (canvas.width - 80) + 40;
                y = Math.random() * (canvas.height - 80) + 40;
            }
            
            balls.push(new Ball(x, y, radius, selectedColor, null, null, speedRange));
            document.getElementById('ballCount').textContent = balls.length;
            updateButtonStates();
            hideAddBallModal();
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function init() {
            // ä»localStorageåŠ è½½æœ€é«˜åˆ†
            highScore = parseInt(localStorage.getItem('collisionBallHighScore')) || 0;
            document.getElementById('highScore').textContent = highScore;
            
            // è®¾ç½®æ»‘å—åˆå§‹å€¼
            document.getElementById('frictionValue').textContent = frictionCoefficient.toFixed(2);
            document.getElementById('gravityValue').textContent = gravityStrength.toFixed(1);
            document.getElementById('speedMultiplierValue').textContent = speedMultiplier.toFixed(1);
            
            // æ·»åŠ æ»‘å—äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('frictionRange').addEventListener('input', function() {
                frictionCoefficient = parseFloat(this.value) / 100;
                document.getElementById('frictionValue').textContent = frictionCoefficient.toFixed(2);
            });
            
            document.getElementById('gravityRange').addEventListener('input', function() {
                gravityStrength = parseFloat(this.value) / 10;
                document.getElementById('gravityValue').textContent = gravityStrength.toFixed(1);
            });
            
            document.getElementById('speedMultiplierRange').addEventListener('input', function() {
                // å°†0-100èŒƒå›´æ˜ å°„ä¸º0.1-5.0çš„é€Ÿåº¦å€ç‡
                speedMultiplier = 0.5 + parseFloat(this.value) * 4.5 / 100;
                updateSpeedIndicator();
            });
            
            // æ¨¡å¼æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    changePhysicsMode(mode);
                });
            });
            
            // æ·»åŠ çƒæ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('addBallBtn').addEventListener('click', showAddBallModal);
            document.getElementById('cancelAddBall').addEventListener('click', hideAddBallModal);
            document.getElementById('confirmAddBall').addEventListener('click', addNewBall);
            
            // é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.preset-color').forEach(el => {
                el.addEventListener('click', function() {
                    selectedColor = this.getAttribute('data-color');
                    document.querySelectorAll('.preset-color').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('customColorInput').value = selectedColor;
                });
            });
            
            document.getElementById('applyCustomColor').addEventListener('click', function() {
                selectedColor = document.getElementById('customColorInput').value;
                document.querySelectorAll('.preset-color').forEach(c => c.classList.remove('selected'));
            });
            
            // åˆ›å»ºåˆå§‹çƒ
            for (let i = 0; i < 3; i++) {
                balls.push(new Ball());
            }
            
            // åˆ›å»ºä¸€ä¸ªé™æ€çƒ
            createStaticBall(canvas.width / 2, canvas.height / 2);
            
            // æ›´æ–°UI
            document.getElementById('ballCount').textContent = balls.length;
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate(0);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ”¹å˜çƒé¢œè‰²
            document.getElementById('changeColorBtn').addEventListener('click', () => {
                if (isPaused) return;
                balls.forEach(ball => {
                    if (!ball.isStatic) {
                        ball.color = colors[Math.floor(Math.random() * colors.length)];
                    }
                });
            });
            
            // æ¸…é™¤æ‰€æœ‰çƒ
            document.getElementById('clearBtn').addEventListener('click', () => {
                if (isPaused) return;
                balls.length = 0;
                collisionCounter = 0;
                score = 0;
                comboCounter = 0;
                document.getElementById('score').textContent = score;
                document.getElementById('ballCount').textContent = 0;
                document.getElementById('collisionCount').textContent = 0;
                document.getElementById('combo').textContent = '0';
                // é‡æ–°åˆ›å»ºé™æ€çƒ
                createStaticBall(canvas.width / 2, canvas.height / 2);
                updateButtonStates();
            });
            
            // é‡ç½®é€Ÿåº¦
            document.getElementById('resetSpeedBtn').addEventListener('click', () => {
                if (isPaused) return;
                resetAllSpeeds();
            });
            
            // æš‚åœ/ç»§ç»­
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            
            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousedown', (e) => {
                if (isPaused) return;
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†çƒ
                let clickedBall = false;
                for (let i = balls.length - 1; i >= 0; i--) {
                    if (balls[i].isClicked(mouseX, mouseY)) {
                        clickedBall = true;
                        if (balls[i].isStatic) {
                            // ç‚¹å‡»é™æ€çƒå°†å…¶ç§»é™¤
                            balls.splice(i, 1);
                            document.getElementById('ballCount').textContent = balls.length;
                        } else {
                            // å¼€å§‹æ‹–æ‹½
                            isDragging = true;
                            draggedBall = balls[i];
                            dragStartX = mouseX;
                            dragStartY = mouseY;
                        }
                        break;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰ç‚¹å‡»åˆ°çƒï¼Œåœ¨ç‚¹å‡»ä½ç½®åˆ›å»ºä¸€ä¸ªé™æ€çƒ
                if (!clickedBall) {
                    createStaticBall(mouseX, mouseY);
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isPaused || !isDragging || !draggedBall) return;
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mouseup', (e) => {
                if (isDragging && draggedBall) {
                    // è®¡ç®—æ‹–æ‹½è·ç¦»å’Œæ–¹å‘
                    const dx = mouseX - dragStartX;
                    const dy = mouseY - dragStartY;
                    
                    // è®¾ç½®çƒçš„é€Ÿåº¦
                    draggedBall.dx = dx * 0.3;
                    draggedBall.dy = dy * 0.3;
                    draggedBall.trail = []; // é‡ç½®è½¨è¿¹
                    
                    isDragging = false;
                    draggedBall = null;
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
                draggedBall = null;
            });
            
            // ç‚¹å‡»canvasæ”¹å˜çƒé¢œè‰²
            canvas.addEventListener('click', (e) => {
                if (isPaused || isDragging) return;
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
                
                // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„çƒ
                for (let i = balls.length - 1; i >= 0; i--) {
                    if (balls[i].isClicked(mouseX, mouseY) && !balls[i].isStatic) {
                        balls[i].color = colors[Math.floor(Math.random() * colors.length)];
                        break;
                    }
                }
            });
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                const container = document.querySelector('.game-container');
                if (window.innerWidth < 650) {
                    canvas.width = container.offsetWidth;
                    canvas.height = container.offsetWidth * 0.67;
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            addBallModal.addEventListener('click', (e) => {
                if (e.target === addBallModal) {
                    hideAddBallModal();
                }
            });
            
            // é€Ÿåº¦å’Œå¤§å°æ»‘å—æ›´æ–°æ˜¾ç¤º
            document.getElementById('ballSpeedRange').addEventListener('input', function() {
                document.getElementById('ballSpeedValue').textContent = this.value;
            });
            
            document.getElementById('ballSizeRange').addEventListener('input', function() {
                document.getElementById('ballSizeValue').textContent = this.value;
            });
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate(timestamp) {
            if (isPaused) return;
            
            // è®¡ç®—å¸§ç‡
            frameCount++;
            if (timestamp - lastTimestamp >= 1000) {
                fps = frameCount;
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastTimestamp = timestamp;
            }
            
            // è®¡ç®—æ—¶é—´å·®
            const deltaTime = timestamp - (lastTimestamp || timestamp);
            lastTimestamp = timestamp;
            
            // æ¸…ç©ºcanvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ£€æµ‹çƒä¹‹é—´çš„ç¢°æ’
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    detectCollision(balls[i], balls[j]);
                }
            }
            
            // æ›´æ–°å¹¶ç»˜åˆ¶æ‰€æœ‰çƒ
            balls.forEach(ball => {
                ball.update(deltaTime);
                ball.draw();
            });
            
            // ç»˜åˆ¶æ‹–æ‹½é¢„è§ˆ
            if (isDragging && draggedBall) {
                ctx.beginPath();
                ctx.moveTo(draggedBall.x, draggedBall.y);
                ctx.lineTo(mouseX, mouseY);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç»˜åˆ¶é€Ÿåº¦é¢„è§ˆç®­å¤´
                const dx = mouseX - draggedBall.x;
                const dy = mouseY - draggedBall.y;
                const length = Math.sqrt(dx*dx + dy*dy);
                if (length > 10) {
                    const arrowSize = 10;
                    const nx = dx / length;
                    const ny = dy / length;
                    
                    ctx.beginPath();
                    ctx.moveTo(mouseX, mouseY);
                    ctx.lineTo(mouseX - (nx * arrowSize + ny * arrowSize/2), mouseY - (ny * arrowSize - nx * arrowSize/2));
                    ctx.lineTo(mouseX - (nx * arrowSize - ny * arrowSize/2), mouseY - (ny * arrowSize + nx * arrowSize/2));
                    ctx.closePath();
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                }
            }
            
            // æ›´æ–°è¿å‡»è®¡æ—¶å™¨
            if (Date.now() - lastCollisionTime > 1500 && comboCounter > 0) {
                comboCounter = 0;
                updateComboDisplay();
            }
            
            // ç»§ç»­åŠ¨ç”»
            animationId = requestAnimationFrame(animate);
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = init;
    </script>
</body>
</html>