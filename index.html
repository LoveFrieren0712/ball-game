<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢°æ’çƒå°æ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 120px);
            background: #222;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .ball {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff9, #f90);
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
            cursor: pointer;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 8px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }
        button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a5a5a;
        }
        button:active {
            background: #3a3a3a;
        }
        .active {
            background: #007bff !important;
        }
        .info-bar {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
            color: #ccc;
        }
        .stat {
            display: inline-block;
            margin: 0 5px;
        }
        .mode-indicator {
            background: #3a3a7f;
            padding: 3px 8px;
            border-radius: 4px;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #start-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        #start-button:hover {
            background: #45a049;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.7);
        }
        #game-title {
            font-size: 48px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.8);
            margin-bottom: 20px;
        }
        #subtitle {
            font-size: 20px;
            color: #aaa;
            margin-bottom: 40px;
        }
        .instructions {
            text-align: center;
            color: #ccc;
            max-width: 600px;
            margin: 20px auto;
            line-height: 1.5;
        }
        .footer {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .score-multiplier {
            color: #ffcc00;
            font-weight: bold;
        }
        .combo-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #ff5555;
            text-shadow: 0 0 10px rgba(255, 85, 85, 0.8);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-value {
            min-width: 40px;
            text-align: right;
        }
        .customization-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(50, 50, 50, 0.9);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>ç¢°æ’çƒå°æ¸¸æˆå¢å¼ºç‰©ç†ç¢°æ’çƒæ¨¡æ‹Ÿå™¨</h1>
    
    <div class="info-bar">
        <div class="stat">é€Ÿåº¦: <span id="speed-display">1.0x</span></div>
        <div class="stat">åˆ†æ•°: <span id="score-display">0</span></div>
        <div class="stat">å†å²æœ€é«˜: <span id="high-score-display">0</span></div>
        <div class="stat">çƒæ•°é‡: <span id="ball-count">3</span> /15</div>
        <div class="stat">ç¢°æ’æ¬¡æ•°: <span id="collision-count">0</span></div>
        <div class="stat">FPS: <span id="fps-display">0</span></div>
        <div class="stat">è¿å‡»: <span id="combo-display-stat">0</span> x</div>
        <div class="stat">ç‰©ç†æ¨¡å¼: <span class="mode-indicator" id="physics-mode">æ ‡å‡†</span></div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <button id="standard-mode" class="active">æ ‡å‡†æ¨¡å¼</button>
            <button id="friction-mode">æ‘©æ“¦åŠ›æ¨¡å¼</button>
            <button id="gravity-mode">é‡åŠ›æ¨¡å¼</button>
            <button id="zero-gravity">é›¶é‡åŠ›</button>
        </div>
        <div class="control-group">
            <button id="random-color">éšæœºé¢œè‰²</button>
            <button id="add-ball">æ·»åŠ çƒ</button>
            <button id="clear-all">æ¸…é™¤æ‰€æœ‰</button>
            <button id="pause">æš‚åœ</button>
        </div>
        <div class="control-group">
            <button id="reset-speed">é‡ç½®é€Ÿåº¦</button>
            <div class="slider-container">
                <label>æ‘©æ“¦åŠ›ç³»æ•°</label>
                <div class="slider-value"><span id="friction-value">0.05</span></div>
            </div>
            <input type="range" id="friction-slider" min="0" max="0.2" step="0.01" value="0.05">
            <div class="slider-container">
                <label>é‡åŠ›å¼ºåº¦</label>
                <div class="slider-value"><span id="gravity-value">0.5</span></div>
            </div>
            <input type="range" id="gravity-slider" min="0" max="2" step="0.1" value="0.5">
            <div class="slider-container">
                <label>æ¸¸æˆé€Ÿåº¦å€ç‡</label>
                <div class="slider-value"><span id="speed-value">1.0</span> x</div>
            </div>
            <input type="range" id="speed-slider" min="0.2" max="3" step="0.1" value="1.0">
        </div>
    </div>
    
    <div id="game-container">
        <div id="start-screen">
            <div id="game-title">ç¢°æ’çƒ</div>
            <div id="subtitle">å¢å¼ºç‰©ç†æ¨¡æ‹Ÿå™¨</div>
            <button id="start-button">å¼€å§‹æ¸¸æˆ</button>
            <div class="instructions">
                âš›ï¸ ç‰©ç†ç‰¹æ€§ï¼šçƒä½“ä¹‹é—´ä¼šçœŸå®ç¢°æ’ï¼Œé€Ÿåº¦å’Œè§’åº¦éµå¾ªåŠ¨é‡å®ˆæ’å®šå¾‹<br>
                ğŸšï¸ æç¤ºï¼šç‚¹å‡»çƒä½“å¯å•ç‹¬æ”¹å˜å…¶é¢œè‰²ï¼Œæ‹–æ‹½å¯è‡ªå®šä¹‰åˆé€Ÿåº¦
            </div>
        </div>
        <div class="combo-display" id="combo-text">è¿å‡» x3!</div>
    </div>
    
    <div class="customization-panel" id="customization-panel">
        <h3>è‡ªå®šä¹‰æ–°çƒå‚æ•°</h3>
        <div class="slider-container">
            <label>åˆå§‹é€Ÿåº¦èŒƒå›´</label>
            <div class="slider-value"><span id="new-ball-speed-value">6</span></div>
        </div>
        <input type="range" id="new-ball-speed" min="1" max="15" step="1" value="6">
        <div class="slider-container">
            <label>çƒä½“å¤§å°</label>
            <div class="slider-value"><span id="new-ball-size-value">25</span></div>
        </div>
        <input type="range" id="new-ball-size" min="10" max="50" step="1" value="25">
        <div>
            <label>çƒä½“é¢œè‰²</label>
            <input type="color" id="new-ball-color" value="#ffcc00">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="apply-customization">åº”ç”¨</button>
            <button id="cancel-customization">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div class="instructions">
        <h3>è®¡åˆ†è§„åˆ™:</h3>
        <ul>
            <li>â€¢ çƒä¸çƒç¢°æ’: +10 åˆ†</li>
            <li>â€¢ çƒä¸è¾¹ç•Œç¢°æ’: +1 åˆ†</li>
            <li>â€¢ è¿ç»­ç¢°æ’(1ç§’å†…): å¥–åŠ±é¢å¤–åˆ†æ•°</li>
            <li>â€¢ åŒæ—¶å­˜åœ¨5ä¸ªä»¥ä¸Šçƒ: åŒå€å¾—åˆ†</li>
            <li>â€¢ é‡åŠ›/æ‘©æ“¦åŠ›æ¨¡å¼: é¢å¤–å¾—åˆ†åŠ æˆ</li>
        </ul>
    </div>
    
    <div class="footer">
        Â© 2023 ç¢°æ’çƒå°æ¸¸æˆ | ç‰©ç†æ¨¡æ‹Ÿå™¨
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let gameStarted = false;
        let gamePaused = false;
        let balls = [];
        let score = 0;
        let highScore = localStorage.getItem('highScore') || 0;
        let collisionCount = 0;
        let lastCollisionTime = 0;
        let comboCount = 0;
        let physicsMode = 'standard'; // 'standard', 'friction', 'gravity', 'zero-gravity'
        let friction = 0.05;
        let gravity = 0.5;
        let gameSpeed = 1.0;
        let lastFrameTime = 0;
        let fps = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let newBallSpeed = 6;
        let newBallSize = 25;
        let newBallColor = '#ffcc00';
        
        // DOMå…ƒç´ 
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const comboText = document.getElementById('combo-text');
        const customizationPanel = document.getElementById('customization-panel');
        
        // åˆå§‹åŒ–
        function initGame() {
            if (gameStarted) return;
            
            // éšè—å¼€å§‹å±å¹•
            startScreen.style.display = 'none';
            gameStarted = true;
            gamePaused = false;
            
            // æ›´æ–°UI
            document.getElementById('high-score-display').textContent = highScore;
            
            // åˆ›å»ºåˆå§‹çƒ
            createInitialBalls();
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            requestAnimationFrame(gameLoop);
        }
        
        // åˆ›å»ºåˆå§‹çƒ
        function createInitialBalls() {
            for (let i = 0; i < 3; i++) {
                createBall();
            }
            updateBallCount();
        }
        
        // åˆ›å»ºå•ä¸ªçƒ
        function createBall(x, y, vx, vy, size, color) {
            if (balls.length >= 15) return null;
            
            const ball = document.createElement('div');
            ball.className = 'ball';
            
            // éšæœºä½ç½®ï¼ˆå¦‚æœæœªæŒ‡å®šï¼‰
            const containerRect = gameContainer.getBoundingClientRect();
            const ballSize = size || newBallSize;
            const posX = x || ballSize + Math.random() * (containerRect.width - 2 * ballSize);
            const posY = y || ballSize + Math.random() * (containerRect.height - 2 * ballSize);
            
            // éšæœºé€Ÿåº¦ï¼ˆå¦‚æœæœªæŒ‡å®šï¼‰
            const speed = vx === undefined ? newBallSpeed : 0;
            const velX = vx !== undefined ? vx : (Math.random() - 0.5) * 2 * speed;
            const velY = vy !== undefined ? vy : (Math.random() - 0.5) * 2 * speed;
            
            // è®¾ç½®çƒå±æ€§
            ball.style.width = ballSize + 'px';
            ball.style.height = ballSize + 'px';
            ball.style.left = posX + 'px';
            ball.style.top = posY + 'px';
            ball.dataset.size = ballSize;
            ball.dataset.color = color || newBallColor;
            ball.style.backgroundColor = ball.dataset.color;
            
            // å°†çƒæ·»åŠ åˆ°å®¹å™¨
            gameContainer.appendChild(ball);
            
            // å°†çƒæ·»åŠ åˆ°æ•°ç»„
            balls.push({
                element: ball,
                x: posX,
                y: posY,
                vx: velX,
                vy: velY,
                radius: ballSize / 2,
                mass: ballSize, // è´¨é‡ä¸å¤§å°æˆæ­£æ¯”
                color: ball.dataset.color,
                lastCollisionTime: 0
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¹å˜é¢œè‰²ï¼‰
            ball.addEventListener('click', function(e) {
                e.stopPropagation();
                if (!gameStarted || gamePaused) return;
                
                const ballData = balls.find(b => b.element === this);
                if (!ballData) return;
                
                // ç”Ÿæˆéšæœºé¢œè‰²
                const hue = Math.floor(Math.random() * 360);
                const newColor = `hsl(${hue}, 80%, 60%)`;
                
                ballData.color = newColor;
                ballData.element.style.backgroundColor = newColor;
                ballData.element.style.background = `radial-gradient(circle at 30% 30%, ${newColor}, ${adjustColor(newColor, -30)})`;
            });
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶
            let isDragging = false;
            let startX, startY;
            
            ball.addEventListener('mousedown', function(e) {
                if (!gameStarted || gamePaused) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                // æš‚åœçƒçš„è¿åŠ¨
                const ballData = balls.find(b => b.element === this);
                if (ballData) {
                    ballData.vx = 0;
                    ballData.vy = 0;
                }
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging || !gameStarted) return;
                
                const ballData = balls.find(b => b.element === ball);
                if (!ballData) return;
                
                // è®¡ç®—æ‹–æ‹½é€Ÿåº¦
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                ballData.vx = dx * 0.5;
                ballData.vy = dy * 0.5;
                
                startX = e.clientX;
                startY = e.clientY;
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            return balls[balls.length - 1];
        }
        
        // è°ƒæ•´é¢œè‰²äº®åº¦
        function adjustColor(color, amount) {
            return color; // ç®€åŒ–ç‰ˆï¼Œå®é™…å¯ä»¥å®ç°é¢œè‰²è°ƒæ•´
        }
        
        // æ›´æ–°çƒçš„ä½ç½®
        function updateBallPositions(deltaTime) {
            if (!gameStarted || gamePaused) return;
            
            const containerRect = gameContainer.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;
            
            for (let i = 0; i < balls.length; i++) {
                const ball = balls[i];
                
                // åº”ç”¨ç‰©ç†æ•ˆæœ
                if (physicsMode === 'friction' || physicsMode === 'gravity') {
                    // æ‘©æ“¦åŠ›
                    ball.vx *= (1 - friction);
                    ball.vy *= (1 - friction);
                    
                    // é‡åŠ›
                    if (physicsMode === 'gravity') {
                        ball.vy += gravity * gameSpeed;
                    }
                }
                
                // ç§»åŠ¨çƒ
                ball.x += ball.vx * deltaTime * gameSpeed;
                ball.y += ball.vy * deltaTime * gameSpeed;
                
                // è¾¹ç•Œç¢°æ’
                const radius = ball.radius;
                
                // æ£€æµ‹Xè½´è¾¹ç•Œç¢°æ’
                if (ball.x - radius < 0) {
                    ball.x = radius;
                    ball.vx = Math.abs(ball.vx); // åå¼¹
                    handleBoundaryCollision(i);
                } else if (ball.x + radius > containerWidth) {
                    ball.x = containerWidth - radius;
                    ball.vx = -Math.abs(ball.vx); // åå¼¹
                    handleBoundaryCollision(i);
                }
                
                // æ£€æµ‹Yè½´è¾¹ç•Œç¢°æ’
                if (ball.y - radius < 0) {
                    ball.y = radius;
                    ball.vy = Math.abs(ball.vy); // åå¼¹
                    handleBoundaryCollision(i);
                } else if (ball.y + radius > containerHeight) {
                    ball.y = containerHeight - radius;
                    ball.vy = -Math.abs(ball.vy); // åå¼¹
                    handleBoundaryCollision(i);
                }
                
                // æ›´æ–°DOMå…ƒç´ ä½ç½®
                ball.element.style.left = (ball.x - radius) + 'px';
                ball.element.style.top = (ball.y - radius) + 'px';
            }
            
            // æ£€æµ‹çƒä¸çƒä¹‹é—´çš„ç¢°æ’
            detectBallCollisions();
        }
        
        // å¤„ç†è¾¹ç•Œç¢°æ’
        function handleBoundaryCollision(ballIndex) {
            const currentTime = Date.now();
            const ball = balls[ballIndex];
            
            // è®¡åˆ†
            addScore(1); // è¾¹ç•Œç¢°æ’+1åˆ†
            
            // æ›´æ–°ç¢°æ’æ¬¡æ•°
            collisionCount++;
            document.getElementById('collision-count').textContent = collisionCount;
            
            // è¿å‡»å¤„ç†
            if (currentTime - lastCollisionTime < 1000) {
                comboCount++;
                showCombo(comboCount);
            } else {
                comboCount = 1;
            }
            lastCollisionTime = currentTime;
            document.getElementById('combo-display-stat').textContent = comboCount;
            
            // è®°å½•æœ€åç¢°æ’æ—¶é—´
            ball.lastCollisionTime = currentTime;
        }
        
        // æ£€æµ‹çƒä¸çƒä¹‹é—´çš„ç¢°æ’
        function detectBallCollisions() {
            const currentTime = Date.now();
            
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    const ball1 = balls[i];
                    const ball2 = balls[j];
                    
                    // è®¡ç®—çƒå¿ƒä¹‹é—´çš„è·ç¦»
                    const dx = ball2.x - ball1.x;
                    const dy = ball2.y - ball1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDistance = ball1.radius + ball2.radius;
                    
                    // æ£€æµ‹æ˜¯å¦ç¢°æ’
                    if (distance < minDistance) {
                        // å¤„ç†ç¢°æ’
                        resolveCollision(ball1, ball2);
                        
                        // åªè®°å½•ä¸€æ¬¡ç¢°æ’
                        if (currentTime - ball1.lastCollisionTime > 100 && currentTime - ball2.lastCollisionTime > 100) {
                            handleBallCollision(i, j);
                        }
                    }
                }
            }
        }
        
        // è§£å†³çƒä¸çƒä¹‹é—´çš„ç¢°æ’
        function resolveCollision(ball1, ball2) {
            const dx = ball2.x - ball1.x;
            const dy = ball2.y - ball1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // å½’ä¸€åŒ–å‘é‡
            const nx = dx / distance;
            const ny = dy / distance;
            
            // æœ€å°è·ç¦»
            const minDistance = ball1.radius + ball2.radius;
            
            // ç¢°æ’æ·±åº¦
            const depth = minDistance - distance;
            
            // ç§»åŠ¨çƒé¿å…é‡å 
            const moveX = nx * depth * 0.5;
            const moveY = ny * depth * 0.5;
            
            ball1.x -= moveX;
            ball1.y -= moveY;
            ball2.x += moveX;
            ball2.y += moveY;
            
            // è®¡ç®—ç›¸å¯¹é€Ÿåº¦
            const vx = ball2.vx - ball1.vx;
            const vy = ball2.vy - ball1.vy;
            
            // è®¡ç®—æ²¿æ³•çº¿æ–¹å‘çš„é€Ÿåº¦åˆ†é‡
            const velocityAlongNormal = vx * nx + vy * ny;
            
            // å¦‚æœçƒç›¸äº’è¿œç¦»ï¼Œåˆ™ä¸éœ€è¦å¤„ç†ç¢°æ’
            if (velocityAlongNormal > 0) return;
            
            // åŠ¨é‡å®ˆæ’è®¡ç®—
            const restitution = 0.8; // æ¢å¤ç³»æ•°
            const impulse = -(1 + restitution) * velocityAlongNormal / (1 / ball1.mass + 1 / ball2.mass);
            
            // åº”ç”¨å†²é‡
            ball1.vx -= (impulse * nx) / ball1.mass;
            ball1.vy -= (impulse * ny) / ball1.mass;
            ball2.vx += (impulse * nx) / ball2.mass;
            ball2.vy += (impulse * ny) / ball2.mass;
        }
        
        // å¤„ç†çƒä¸çƒçš„ç¢°æ’
        function handleBallCollision(ballIndex1, ballIndex2) {
            const currentTime = Date.now();
            
            // è®¡åˆ† - çƒä¸çƒç¢°æ’+10åˆ†
            let points = 10;
            
            // é¢å¤–åŠ åˆ†è§„åˆ™
            const multiplier = calculateScoreMultiplier();
            points *= multiplier;
            
            addScore(points);
            
            // æ›´æ–°ç¢°æ’æ¬¡æ•°
            collisionCount++;
            document.getElementById('collision-count').textContent = collisionCount;
            
            // è¿å‡»å¤„ç†
            if (currentTime - lastCollisionTime < 1000) {
                comboCount++;
                showCombo(comboCount);
            } else {
                comboCount = 1;
            }
            lastCollisionTime = currentTime;
            document.getElementById('combo-display-stat').textContent = comboCount;
            
            // è®°å½•æœ€åç¢°æ’æ—¶é—´
            balls[ballIndex1].lastCollisionTime = currentTime;
            balls[ballIndex2].lastCollisionTime = currentTime;
        }
        
        // æ˜¾ç¤ºè¿å‡»æ•ˆæœ
        function showCombo(count) {
            if (count < 2) return;
            
            comboText.textContent = `è¿å‡» x${count}!`;
            comboText.style.opacity = '1';
            
            // åŠ¨ç”»æ•ˆæœ
            let scale = 1;
            const animate = () => {
                if (scale < 1.5) {
                    scale += 0.05;
                    comboText.style.transform = `translateX(-50%) scale(${scale})`;
                    requestAnimationFrame(animate);
                }
            };
            animate();
            
            // é€æ¸æ¶ˆå¤±
            setTimeout(() => {
                comboText.style.opacity = '0';
                comboText.style.transform = 'translateX(-50%) scale(1)';
            }, 1000);
        }
        
        // è®¡ç®—å¾—åˆ†å€ç‡
        function calculateScoreMultiplier() {
            let multiplier = 1;
            
            // å¤šçƒåŠ æˆ
            if (balls.length >= 5) {
                multiplier *= 2;
            }
            
            // ç‰©ç†æ¨¡å¼åŠ æˆ
            if (physicsMode === 'friction' || physicsMode === 'gravity') {
                multiplier *= 1.5;
            }
            
            // è¿å‡»åŠ æˆ
            if (comboCount > 1) {
                multiplier *= (1 + comboCount * 0.1);
            }
            
            return multiplier;
        }
        
        // æ·»åŠ åˆ†æ•°
        function addScore(points) {
            score += points;
            document.getElementById('score-display').textContent = Math.floor(score);
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('highScore', highScore);
                document.getElementById('high-score-display').textContent = Math.floor(highScore);
            }
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop(timestamp) {
            if (!gameStarted) return;
            
            // è®¡ç®—å¸§ç‡
            if (!lastFrameTime) lastFrameTime = timestamp;
            const deltaTime = (timestamp - lastFrameTime) / 1000; // è½¬æ¢ä¸ºç§’
            lastFrameTime = timestamp;
            
            // æ›´æ–°FPS
            frameCount++;
            if (timestamp - lastFpsUpdate > 1000) {
                fps = frameCount;
                document.getElementById('fps-display').textContent = fps;
                frameCount = 0;
                lastFpsUpdate = timestamp;
            }
            
            // æ›´æ–°çƒçš„ä½ç½®
            updateBallPositions(deltaTime);
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            if (!gamePaused) {
                requestAnimationFrame(gameLoop);
            }
        }
        
        // æ›´æ–°çƒçš„æ•°é‡æ˜¾ç¤º
        function updateBallCount() {
            document.getElementById('ball-count').textContent = balls.length;
        }
        
        // æ¸…é™¤æ‰€æœ‰çƒ
        function clearAllBalls() {
            balls.forEach(ball => {
                if (ball.element && ball.element.parentNode) {
                    ball.element.parentNode.removeChild(ball.element);
                }
            });
            balls = [];
            updateBallCount();
        }
        
        // æš‚åœ/æ¢å¤æ¸¸æˆ
        function togglePause() {
            gamePaused = !gamePaused;
            document.getElementById('pause').textContent = gamePaused ? 'ç»§ç»­' : 'æš‚åœ';
            
            if (!gamePaused) {
                lastFrameTime = 0; // é‡ç½®å¸§æ—¶é—´
                requestAnimationFrame(gameLoop);
            }
        }
        
        // é‡ç½®æ‰€æœ‰çƒçš„é€Ÿåº¦
        function resetBallSpeeds() {
            balls.forEach(ball => {
                ball.vx = (Math.random() - 0.5) * 10;
                ball.vy = (Math.random() - 0.5) * 10;
            });
        }
        
        // éšæœºåŒ–æ‰€æœ‰çƒçš„é¢œè‰²
        function randomizeBallColors() {
            balls.forEach(ball => {
                const hue = Math.floor(Math.random() * 360);
                const newColor = `hsl(${hue}, 80%, 60%)`;
                ball.color = newColor;
                ball.element.style.backgroundColor = newColor;
                ball.element.style.background = `radial-gradient(circle at 30% 30%, ${newColor}, ${adjustColor(newColor, -30)})`;
            });
        }
        
        // è®¾ç½®ç‰©ç†æ¨¡å¼
        function setPhysicsMode(mode) {
            physicsMode = mode;
            document.getElementById('physics-mode').textContent = 
                mode === 'standard' ? 'æ ‡å‡†' : 
                mode === 'friction' ? 'æ‘©æ“¦åŠ›' : 
                mode === 'gravity' ? 'é‡åŠ›' : 'é›¶é‡åŠ›';
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('standard-mode').classList.toggle('active', mode === 'standard');
            document.getElementById('friction-mode').classList.toggle('active', mode === 'friction');
            document.getElementById('gravity-mode').classList.toggle('active', mode === 'gravity');
            document.getElementById('zero-gravity').classList.toggle('active', mode === 'zero-gravity');
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        startButton.addEventListener('click', initGame);
        
        document.getElementById('add-ball').addEventListener('click', function() {
            if (!gameStarted) return;
            if (balls.length < 15) {
                createBall();
                updateBallCount();
            }
        });
        
        document.getElementById('clear-all').addEventListener('click', function() {
            if (!gameStarted) return;
            clearAllBalls();
        });
        
        document.getElementById('pause').addEventListener('click', function() {
            if (!gameStarted) return;
            togglePause();
        });
        
        document.getElementById('reset-speed').addEventListener('click', function() {
            if (!gameStarted) return;
            resetBallSpeeds();
        });
        
        document.getElementById('random-color').addEventListener('click', function() {
            if (!gameStarted) return;
            randomizeBallColors();
        });
        
        // ç‰©ç†æ¨¡å¼æŒ‰é’®
        document.getElementById('standard-mode').addEventListener('click', function() {
            setPhysicsMode('standard');
        });
        
        document.getElementById('friction-mode').addEventListener('click', function() {
            setPhysicsMode('friction');
        });
        
        document.getElementById('gravity-mode').addEventListener('click', function() {
            setPhysicsMode('gravity');
        });
        
        document.getElementById('zero-gravity').addEventListener('click', function() {
            setPhysicsMode('zero-gravity');
        });
        
        // æ»‘å—äº‹ä»¶
        document.getElementById('friction-slider').addEventListener('input', function() {
            friction = parseFloat(this.value);
            document.getElementById('friction-value').textContent = friction.toFixed(2);
        });
        
        document.getElementById('gravity-slider').addEventListener('input', function() {
            gravity = parseFloat(this.value);
            document.getElementById('gravity-value').textContent = gravity.toFixed(1);
        });
        
        document.getElementById('speed-slider').addEventListener('input', function() {
            gameSpeed = parseFloat(this.value);
            document.getElementById('speed-value').textContent = gameSpeed.toFixed(1);
            document.getElementById('speed-display').textContent = gameSpeed.toFixed(1) + 'x';
        });
        
        // è‡ªå®šä¹‰æ–°çƒå‚æ•°
        document.getElementById('new-ball-speed').addEventListener('input', function() {
            newBallSpeed = parseInt(this.value);
            document.getElementById('new-ball-speed-value').textContent = newBallSpeed;
        });
        
        document.getElementById('new-ball-size').addEventListener('input', function() {
            newBallSize = parseInt(this.value);
            document.getElementById('new-ball-size-value').textContent = newBallSize;
        });
        
        document.getElementById('new-ball-color').addEventListener('input', function() {
            newBallColor = this.value;
        });
        
        // æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿
        document.getElementById('add-ball').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            customizationPanel.style.display = 'block';
        });
        
        // åº”ç”¨è‡ªå®šä¹‰è®¾ç½®
        document.getElementById('apply-customization').addEventListener('click', function() {
            customizationPanel.style.display = 'none';
        });
        
        // å–æ¶ˆè‡ªå®šä¹‰è®¾ç½®
        document.getElementById('cancel-customization').addEventListener('click', function() {
            customizationPanel.style.display = 'none';
        });
        
        // ç‚¹å‡»å®¹å™¨å…³é—­è‡ªå®šä¹‰é¢æ¿
        gameContainer.addEventListener('click', function() {
            customizationPanel.style.display = 'none';
        });
        
        // åˆå§‹åŒ–UI
        document.getElementById('friction-value').textContent = friction.toFixed(2);
        document.getElementById('gravity-value').textContent = gravity.toFixed(1);
        document.getElementById('speed-value').textContent = gameSpeed.toFixed(1);
        document.getElementById('speed-display').textContent = gameSpeed.toFixed(1) + 'x';
        document.getElementById('high-score-display').textContent = highScore;
        document.getElementById('new-ball-speed-value').textContent = newBallSpeed;
        document.getElementById('new-ball-size-value').textContent = newBallSize;
        
        // è®¾ç½®é»˜è®¤ç‰©ç†æ¨¡å¼
        setPhysicsMode('standard');
        
        // çª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°
        window.addEventListener('resize', function() {
            if (gameStarted) {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è°ƒæ•´é€»è¾‘
            }
        });
    </script>
</body>
</html>
